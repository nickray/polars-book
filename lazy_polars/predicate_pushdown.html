<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Predicate pushdown - polars-book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../lazy_polars/intro.html"><strong aria-hidden="true">2.</strong> Lazy Polars</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lazy_polars/predicate_pushdown.html" class="active"><strong aria-hidden="true">2.1.</strong> Predicate pushdown</a></li><li class="chapter-item expanded "><a href="../lazy_polars/projection_pushdown.html"><strong aria-hidden="true">2.2.</strong> Projection pushdown</a></li><li class="chapter-item expanded "><a href="../lazy_polars/other_optimizations.html"><strong aria-hidden="true">2.3.</strong> Other optimizations</a></li></ol></li><li class="chapter-item expanded "><a href="../how_can_i/intro.html"><strong aria-hidden="true">3.</strong> How can I?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../how_can_i/groupby.html"><strong aria-hidden="true">3.1.</strong> GroupBy</a></li><li class="chapter-item expanded "><a href="../how_can_i/aggregate.html"><strong aria-hidden="true">3.2.</strong> Aggregate</a></li><li class="chapter-item expanded "><a href="../how_can_i/conditionally_apply.html"><strong aria-hidden="true">3.3.</strong> Conditionally apply</a></li><li class="chapter-item expanded "><a href="../how_can_i/parse_dates.html"><strong aria-hidden="true">3.4.</strong> Parse dates</a></li><li class="chapter-item expanded "><a href="../how_can_i/use_custom_functions.html"><strong aria-hidden="true">3.5.</strong> Use custom functions</a></li><li class="chapter-item expanded "><a href="../how_can_i/process_strings.html"><strong aria-hidden="true">3.6.</strong> Process strings</a></li><li class="chapter-item expanded "><a href="../how_can_i/apply_window_functions.html"><strong aria-hidden="true">3.7.</strong> Apply window functions</a></li><li class="chapter-item expanded "><a href="../how_can_i/split_apply_combine.html"><strong aria-hidden="true">3.8.</strong> Split/ apply / combine</a></li></ol></li><li class="chapter-item expanded "><a href="../numpy.html"><strong aria-hidden="true">4.</strong> Numpy interop</a></li><li class="chapter-item expanded "><a href="../reference.html"><strong aria-hidden="true">5.</strong> Reference guide</a></li><li class="chapter-item expanded "><a href="../micro_benchmarks.html"><strong aria-hidden="true">6.</strong> Micro benchmarks</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">polars-book</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#predicate-pushdown" id="predicate-pushdown">Predicate pushdown</a></h1>
<p>Predicate pushdown is an optimization Polars does that reduces query times and memory usage. 
A predicate is database jargon for applying a filter on some table and thereby reducing number the number of rows on that
table.</p>
<p>So let's see if we can load some Reddit data and filter on a few predicates.</p>
<pre><code class="language-python">from pypolars.lazy import *

# A scan is a lazy read. This means nothing happens.
reddit = pl.scan_csv(&quot;data/reddit.csv&quot;)

reddit = (
    reddit.filter(col(&quot;comment_karma&quot;) &gt; 0)  # only positive comment karma
    .filter(col(&quot;link_karma&quot;) &gt; 0)  # only positive link karma
    .filter(col(&quot;name&quot;).str_contains(r&quot;^a&quot;))  # filter name that start with an &quot;a&quot;
)
</code></pre>
<p>If we were to run this query above, nothing would happen! This due to the lazyness, nothing will happend until specifically
requested. This allows Polars to see the whole context of a query and optimize just in time for execution.</p>
<p>Execution is requested by the <code>.collect</code> method. This would query all available data. During writing/ optimizing/ checking
your query this is often not what you want. Another method that calls for execution is the <code>.fetch</code> method. <code>.fetch</code> takes 
a parameter <code>n_rows</code> and tries to 'fetch' that number of rows at the data source (no guarantees are given though). </p>
<p>So let's &quot;fetch&quot; ~10 Million rows from the source file and apply the predicates.</p>
<pre><code class="language-python">reddit.fetch(n_rows=int(1e7))
</code></pre>
<pre><code class="language-text">shape: (61503, 6)
╭──────────┬───────────────────┬─────────────┬────────────┬───────────────┬────────────╮
│ id       ┆ name              ┆ created_utc ┆ updated_on ┆ comment_karma ┆ link_karma │
│ ---      ┆ ---               ┆ ---         ┆ ---        ┆ ---           ┆ ---        │
│ i64      ┆ str               ┆ i64         ┆ i64        ┆ i64           ┆ i64        │
╞══════════╪═══════════════════╪═════════════╪════════════╪═══════════════╪════════════╡
│ 77860    ┆ aquarin           ┆ 1137474000  ┆ 1536528294 ┆ 150           ┆ 11         │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 77974    ┆ aadvaark          ┆ 1137301200  ┆ 1536528294 ┆ 26            ┆ 47         │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 78004    ┆ apoisel           ┆ 1137301200  ┆ 1536497404 ┆ 42            ┆ 2549       │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 78041    ┆ aonic             ┆ 1137301200  ┆ 1536497404 ┆ 2931          ┆ 2095       │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ ...      ┆ ...               ┆ ...         ┆ ...        ┆ ...           ┆ ...        │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 15814987 ┆ alexzee2          ┆ 1351228286  ┆ 1536588902 ┆ 526           ┆ 993        │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 15815549 ┆ aavy              ┆ 1351231221  ┆ 1536498711 ┆ 570           ┆ 12173      │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 15815591 ┆ airplanechampagne ┆ 1351231470  ┆ 1536588904 ┆ 1493          ┆ 2498       │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 15815810 ┆ atomthebroken     ┆ 1351232817  ┆ 1536588905 ┆ 5             ┆ 53         │
├╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌┤
│ 15815882 ┆ ahndroo           ┆ 1351233206  ┆ 1536588905 ┆ 43            ┆ 12         │
╰──────────┴───────────────────┴─────────────┴────────────┴───────────────┴────────────╯
</code></pre>
<p>Above we see that from the 10 Million rows, 61503 rows match our predicate. </p>
<h2><a class="header" href="#break-it-down" id="break-it-down">Break it down</a></h2>
<p>In Polars we can visualize the query plan. Let's take a look.</p>
<pre><code class="language-python">reddit.show_graph(optimized=False)
</code></pre>
<p><img src="../img/predicate_pushdown_0.png" alt="query_plan" /></p>
<p>The astute reader maybe would notice that our query is not very optimal because we have 3 separate <em>FILTER</em> nodes. 
That means that after every <em>FILTER</em> a new DataFrame is allocated, which will be input to the next <em>FILTER</em> and then 
deleted from memory, that must be redundant.
And you know what.. He/she is right, the predicates should be combined, we should have written this query:</p>
<pre><code class="language-python">reddit_2 = reddit.filter(
    (col(&quot;comment_karma&quot;) &gt; 0)
    &amp; (col(&quot;link_karma&quot;) &gt; 0)
    &amp; (col(&quot;name&quot;).str_contains(r&quot;^a&quot;))
)
</code></pre>
<p>That would translate to:</p>
<pre><code class="language-python">reddit_2.show_graph(optimized=False)
</code></pre>
<p><img src="../img/predicate_pushdown_1.png" alt="query_plan" /></p>
<p>As we can see the predicates are combined. This would lead to less copying of data </p>
<h2><a class="header" href="#in-comes-optimization" id="in-comes-optimization">In comes optimization</a></h2>
<p>Polars tries to save that mental overhead from the query writer and combines predicates for you. Besides that, it pushes 
predicates down to the scan level! Let's see how our optimized query looks.</p>
<pre><code class="language-python">reddit.show_graph(optimized=True)
</code></pre>
<p><img src="../img/predicate_pushdown_0_optimized.png" alt="query_plan" /></p>
<p>It may be hard to see, but what is clear is that there is only a single node; the <em>CSV SCAN</em>. The predicate filtering
is done during the reading of the csv. This means that this query's memory overhead is reduced by filtering factor!
This makes a huge impact. </p>
<h3><a class="header" href="#memory" id="memory">Memory</a></h3>
<p>As we have seen there were ~ 62,000 rows left after the <em>FILTER</em>. That means that 
(aside for some memory overhead of the batch size and filter operations) we use \( \frac{6.2\text{e-}4}{1\text{e-}7} \sim 0.6 \text{%} \) 
of the memory we would during an eager evaluation where we first would read the whole table in memory before applying a filter.</p>
<h3><a class="header" href="#performance" id="performance">Performance</a></h3>
<p>At the time of writing this, the predicate pushdown also increased the query time performance.</p>
<p><strong>without optimization</strong></p>
<p><code>$ time time python -m book.src.examples.lazy_chapter.predicate_pushdown_0_timing False</code></p>
<pre><code class="language-text">real	0m2,401s
user	0m5,457s
sys	0m0,894s
</code></pre>
<p><strong>with optimization</strong></p>
<p><code>$ time time python -m book.src.examples.lazy_chapter.predicate_pushdown_0_timing True</code></p>
<pre><code class="language-text">real	0m1,597s
user	0m6,143s
sys	0m0,647s
</code></pre>
<h2><a class="header" href="#relational-algebra" id="relational-algebra">Relational algebra</a></h2>
<p>In the visualization of the query plan, you see a \( \sigma \) symbol. This indicates a Predicate done at the <em>SCAN</em> level.
There is also a \( \pi \) symbol indicating projection (database jargon for column selection), but we'll get to that later.</p>
<h2><a class="header" href="#cheaper-joins" id="cheaper-joins">Cheaper joins</a></h2>
<p>Predicate pushdown optimization will generally also lead to cheaper join's. A join is quite an expensive operation
the less rows we through at a join operation, the cheaper it becomes.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../lazy_polars/intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../lazy_polars/projection_pushdown.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../lazy_polars/intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../lazy_polars/projection_pushdown.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
